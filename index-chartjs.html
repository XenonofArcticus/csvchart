<!DOCTYPE html>

<html>
<head>
	<title>AlphaPixel CSVChart (ChartJS)</title>

	<!--
	<link href="https://netdna.bootstrapcdn.com/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">

	<script src="https://code.jquery.com/jquery-1.11.0.min.js"></script>
	<script src="https://netdna.bootstrapcdn.com/bootstrap/5.1.3/js/bootstrap.min.js"></script>
	<script src="https://www.gstatic.com/charts/loader.js"></script>
	-->

	<link href="lib/bootstrap-5.1.3.min.css" rel="stylesheet">

	<script src="lib/jquery-1.11.0.min.js"></script>
	<script src="lib/bootstrap-5.1.3.min.js"></script>
	<script src="lib/papaparse.min.js"></script>
	<script src="lib/csvchart.js"></script>

	<script src="https://cdn.jsdelivr.net/npm/chart.js@3.8.0/dist/chart.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

	<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.1/themes/smoothness/jquery-ui.css">

	<script src="https://code.jquery.com/jquery-3.6.0.js"></script>
	<script src="https://code.jquery.com/ui/1.13.1/jquery-ui.js"></script>

	<style>
		html, body {
			margin: 0;
			height: 100%;
			min-height: 100%;
		}

		body {
			margin: 0;
			display: flex;
			flex-direction: column;
		}

		header {
			flex: 1;
			/* background: red; */
			border-bottom: solid 1px gray;
		}

		chart {
			flex: 8;
			overflow: auto;
			background: rgb(230, 230, 230);
			/* padding: 10px; */
		}

		footer {
			flex: 1;
			/* background: gray; */
			border-top: solid 1px gray;
			padding: 10px;
		}
	</style>

	<script>
		var myChart = null;

		function drawChart(d) {
			const ctx = document.getElementById("myChart").getContext("2d");

			const data = {
				datasets: [{
					label: "TODO!",
					data: d,
					backgroundColor: "rgb(255, 99, 132)"
				}]
			};

			myChart = new Chart(ctx, {
				type: "scatter",
				plugins: [ChartDataLabels],
				data: data,
				options: {
					elements: {
						point: {
							radius: 6
						},
					},
					animation: {
						onComplete: updateFooter
					},
					plugins: {
						// https://chartjs-plugin-datalabels.netlify.app/guide/options.html#scriptable-options
						datalabels: {
							align: "top",
							// color: "rgb(240, 240, 240)",
							color: "rgb(255, 99, 132)",
							backgroundColor: "rgb(175, 175, 175)",
							font: {
								size: 10,
								lineHeight: 1,
							},
							formatter: function(e) {
								return e.label;
							}
						}
					} /*,
					scales: {
						x: {
							type: "logarithmic"
						}
					} */
				}
			});
		}

		function updateFooter() {
			// myChart.canvas.parentNode.style.width + " x " +
			// myChart.canvas.parentNode.style.height

			var mcd = $("#myChartDiv");

			$("#dimensions").text(parseInt(mcd.width()) + " x " + parseInt(mcd.height()));
		}

		$(function() {
			$(document).on("change", ":file", function() {
				var fr = new FileReader();

				fr.onload = function() {
					/* var csv = Papa.parse(fr.result, {
						dynamicTyping: true,
						skipEmptyLines: true,
						header: true
					}).data.map(e => { return {
						"x": e["Search Volume"],
						"y": e["Keyword Difficulty"],
						"label": e["Keyword"]
					}});

					// console.log(csv, JSON.stringify(csv)); */

					var csv = CSVChart.ChartJS.parse(fr.result);

					drawChart(csv);
				}

				fr.readAsText(this.files[0]);

				/* var input = $(this),

				numFiles = input.get(0).files ? input.get(0).files.length : 1,
				label = input.val().replace(/\\/g, "/").replace(/.*\//, "");

				input.trigger("inputfile", [numFiles, label]); */
			});
		});

		// https://www.chartjs.org/docs/2.7.2/general/responsive.html
		// TODO: In order for this to work properly, we need to store the "first" size.
		$(function() {
			$("#scale-slider" ).slider({
				range: "min",
				value: 1,
				min: 1,
				max: 30,
				slide: function(event, ui) {
					$("#scale").val(ui.value);

					if(myChart) {
						var w = myChart.canvas.width;
						var h = myChart.canvas.height;

						// console.log("width = " + w);
						// console.log("height = " + h);

						myChart.canvas.parentNode.style.width = "2000px";
						myChart.canvas.parentNode.style.height = "1000px";

						myChart.update();

						updateFooter();
					}
				}
			});

			// This sets the initial value.
			$("#scale").val($("#scale-slider").slider("value"));
		});
	</script>
</head>
<body>
	<header>
		<div class="container" style="margin: 10px;">
			<div class="row">
				<div class="col-lg-6 col-sm-6 col-12">
					<img src="logo.png"/>
				</div>

				<div class="col-lg-6 col-sm-6 col-12">
					<h4>CSV File(s)</h4>
					<div class="input-group">
						<label class="input-group-btn">
							<span class="btn btn-primary">
								Select&hellip; <input type="file" style="display: none;" name="inputfile" id="inputfile">
							</span>
						</label>
						<input type="text" class="form-control" readonly>
					</div>

					<span class="help-block">
						You may select one or more CSV files.
					</span>
				</div>
			</div>
		</div>
	</header>
	<chart id="foo">
		<div id="myChartDiv" style="position: relative; height:40vh; width:80vw;">
			<canvas id="myChart"></canvas>
		</div>

		<script>
			// https://stackoverflow.com/questions/15036386/make-image-drawn-on-canvas-draggable-with-javascript
			$(function() {
				// Import the constant variables "offsetX" and "offsetY" when the page loads.
				// TODO: This should be recalculated if the "myChart" is repositioned.
				const {left: offsetX, top: offsetY} = $("#myChart").offset();

				// The variables "xx" and "yy" are the PREVIOUS x/y values from a prior "onmousemove" event.
				var xx = 0;
				var yy = 0;

				// Boolean flag for setting the "okay-to-drag" state.
				var drag = false;

				$("#myChart").mousedown((e) => { drag = true; });
				$("#myChart").mouseup((e) => { drag = false; });
				$("#myChart").mouseout((e) => { drag = false; });
				$("#myChart").mousemove((e) => {
					var x = parseInt(e.clientX - offsetX);
					var y = parseInt(e.clientY - offsetY);

					if(drag) {
						// Scroll X and Y values (sx/sy) are positive/negative differences between the
						// CURRENT X/Y value and the PREVIOUS.
						var sx = 0;
						var sy = 0;

						if(x > xx) sx = x - xx;

						else if(x < xx) sx = -(xx - x);

						if(y > yy) sy = y - yy;

						else if(y < yy) sy = -(yy - y);

						// TODO: Rather than invert here, would it make more sense to do the inversion
						// in the lines of code above?
						// document.getElementById("myChartDiv").scrollBy(-sx, -sy);
						document.getElementById("foo").scrollBy(-sx, -sy);

						console.log(`x=${sx} y=${sy}`);
					}

					// Whether we're "dragging" or not, set the CURRENT X/Y as the PREVIOUS.
					xx = x;
					yy = y;
				});
			});
		</script>

	</chart>
	<footer>
		<div class="container-fluid">
			<div class="row">
				<div class="col-lg-6 col-sm-6 col-12">
					<div class="row-6">
						<label for="scale">Chart Scale:</label>
						<input type="text" id="scale" readonly style="border:0; color:#f6931f; font-weight:bold;">
					</div>
					<div id="dimensions" class="row-6">
						...
					</div>
				</div>

				<div class="col-lg-6 col-sm-6 col-12">
					<div class="row-6">
						<div id="scale-slider"></div>
					</div>
					<div class="row-6">
						TODO
					</div>
				</div>
			</div>
		</div>
	</footer>
</body>
</html>
